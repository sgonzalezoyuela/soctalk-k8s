apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: soctalk

resources:
- ../../base
- ingress.yaml

# Generate secrets from env file
secretGenerator:
- envs:
  - secrets.env
  name: soctalk-db-secrets
  options:
    disableNameSuffixHash: true
- envs:
  - secrets.env
  name: soctalk-llm-secrets
  options:
    disableNameSuffixHash: true
- envs:
  - secrets.env
  name: soctalk-soc-secrets
  options:
    disableNameSuffixHash: true

# Override images with your production registry
images:
- name: REGISTRY/soctalk-api
  newName: ghcr.io/soctalk/soctalk-api
  newTag: v1.0.0
- name: REGISTRY/soctalk-frontend
  newName: ghcr.io/soctalk/soctalk-frontend
  newTag: v1.0.0
- name: REGISTRY/soctalk-orchestrator
  newName: ghcr.io/soctalk/soctalk-orchestrator
  newTag: v1.0.0

patches:
# Replicas
- target:
    kind: Deployment
    name: api
  patch: |
    - op: replace
      path: /spec/replicas
      value: 2
- target:
    kind: Deployment
    name: frontend
  patch: |
    - op: replace
      path: /spec/replicas
      value: 2
- target:
    kind: Deployment
    name: orchestrator
  patch: |
    - op: replace
      path: /spec/replicas
      value: 1
# Resources - API
- target:
    kind: Deployment
    name: api
  patch: |
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "256Mi"
          cpu: "200m"
        limits:
          memory: "512Mi"
          cpu: "500m"
# Resources - Frontend
- target:
    kind: Deployment
    name: frontend
  patch: |
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "200m"
# Resources - Orchestrator
- target:
    kind: Deployment
    name: orchestrator
  patch: |
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "512Mi"
          cpu: "200m"
        limits:
          memory: "1Gi"
          cpu: "1000m"
# Resources - Postgres
- target:
    kind: StatefulSet
    name: postgres
  patch: |
    - op: add
      path: /spec/template/spec/containers/0/resources
      value:
        requests:
          memory: "512Mi"
          cpu: "200m"
        limits:
          memory: "1Gi"
          cpu: "1000m"

# ConfigMap patches for production URLs
configMapGenerator:
- behavior: merge
  literals:
  - PUBLIC_API_URL=https://api.soctalk.example.com
  name: frontend-config
- behavior: merge
  literals:
  - CORS_ORIGINS=https://soctalk.example.com
  name: api-config

# Production-specific labels
labels:
- includeSelectors: true
  pairs:
    environment: prod
